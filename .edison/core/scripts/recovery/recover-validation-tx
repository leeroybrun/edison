#!/usr/bin/env python3
"""
Wrapper script for recovering incomplete validation transactions.
Maps legacy script interface to Python module: edison.core.session.lifecycle.recovery
"""
import sys
import argparse
import os
from pathlib import Path

# Ensure edison package is importable
REPO_ROOT = Path(__file__).resolve().parents[4]
if str(REPO_ROOT / "src") not in sys.path:
    sys.path.insert(0, str(REPO_ROOT / "src"))

from edison.core.session.lifecycle.recovery import recover_incomplete_validation_transactions, detect_incomplete_transactions
from edison.core.utils.paths import PathResolver


def main():
    parser = argparse.ArgumentParser(description="Recover incomplete validation transactions")
    parser.add_argument("--dry-run", action="store_true", help="Show incomplete transactions without recovering")
    parser.add_argument("--force", action="store_true", help="Force recovery of incomplete transactions")
    parser.add_argument("--session", required=True, help="Session ID to recover")
    args = parser.parse_args()

    # Set project root from environment if provided
    if "AGENTS_PROJECT_ROOT" in os.environ:
        PathResolver._project_root_override = Path(os.environ["AGENTS_PROJECT_ROOT"])

    try:
        if args.dry_run:
            # List incomplete transactions for the session
            all_incomplete = detect_incomplete_transactions()
            session_incomplete = [tx for tx in all_incomplete if tx["sessionId"] == args.session]

            if not session_incomplete:
                print(f"No incomplete transactions found for session {args.session}")
                return 0

            print(f"Found {len(session_incomplete)} incomplete transaction(s) for session {args.session}:")
            for tx in session_incomplete:
                print(f"  Transaction ID: {tx['txId']}")
                print(f"    Started at: {tx['startedAt']}")
                print(f"    Transaction dir: {tx['txDir']}")
            return 0

        # Actually recover transactions
        recovered = recover_incomplete_validation_transactions(args.session)
        if recovered > 0:
            print(f"Recovered {recovered} incomplete transaction(s) for session {args.session}")
        else:
            print(f"No incomplete transactions found for session {args.session}")
        return 0

    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        import traceback
        traceback.print_exc(file=sys.stderr)
        return 1


if __name__ == "__main__":
    sys.exit(main())

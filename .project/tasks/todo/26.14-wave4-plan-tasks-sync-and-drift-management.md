---
id: "26.14-wave4-plan-tasks-sync-and-drift-management"
title: "Plan Mode: drift detection + plan↔tasks sync/update workflows (no duplicate tasks)"
type: feature
owner:
session_id:
parent_id:
child_ids:
depends_on:
  - "26.8-wave3-plan-generate-tasks"
  - "26.12-wave4-plan-analysis-and-correct-course"
blocks_tasks:
related:
  - "26.7-wave3-plan-spec-validate-and-similarity"
  - "26.11-wave3-plan-tasks-list-command"
claimed_at:
last_active:
continuation_id:
created_at: "2025-12-31T00:00:00Z"
updated_at: "2025-12-31T00:00:00Z"
tags:
  - plan-mode
  - generation
  - validation
  - tasks
priority: high
estimated_hours:
model:
---

# Plan Mode: drift detection + plan↔tasks sync/update workflows (no duplicate tasks)

## Summary

Once Plan Mode can generate tasks, Edison must also support safe evolution:
- detect plan drift after generation
- avoid generating duplicates or diverging competing task sets
- provide explicit workflows to sync/update tasks when a plan changes

This task plans (and later implements) deterministic drift detection + sync operations, plus matching slash command workflows.

## Required Reading

- `.project/plans/plan-1-plan-mode.md` (generation_history, task_id_prefix, drift concerns)
- `.project/tasks/todo/26.7-wave3-plan-spec-validate-and-similarity.md` (validate output contract)
- `.project/tasks/todo/26.8-wave3-plan-generate-tasks.md` (generation write-back)
- Optional vendor references (if available; do not block if missing):
  - OpenSpec validate UX reference: `OpenSpec/src/commands/validate.ts`
  - BMAD correct-course workflow reference: `BMAD-METHOD/.../correct-course/checklist.md`

## Objectives

### Deterministic drift detection
- [ ] Extend plan write-back (`generation_history`) to store a stable fingerprint of the Plan Spec used for generation:
  - e.g. `spec_hash` = sha256 of normalized `yaml edison-plan` block
- [ ] Add drift rules:
  - If plan spec hash differs from last generation, `edison plan generate-tasks` must fail closed unless `--force` (or explicit `--allow-drift`) is provided.
  - Provide a deterministic drift summary (what keys/titles/waves changed).

### Sync/update workflows (planned interface)
- [ ] Plan a `edison plan sync-tasks <plan-id>` CLI (future work) with modes:
  - `--dry-run` (default): print proposed task changes
  - `--apply` (explicit): apply changes
  - operations include: add missing tasks, mark removed tasks as archived/blocked, update titles/acceptance, update dependencies
  - strictly avoid rewriting task bodies wholesale; prefer targeted edits
  - MUST preserve user edits to tasks (treat tasks as source of truth for implementation details; Plan Spec is the intent)
  - MUST be idempotent when there is no drift (dry-run shows no changes; apply does nothing)

### Slash command workflows
- [ ] Add plan-mode slash command definition `src/edison/data/commands/plan/plan-sync-tasks.md`:
  - read-only by default
  - requires `plan validate --json` + `plan tasks --json`
  - outputs “proposed sync plan” + ask gate
- [ ] Add a related “plan refine” command definition:
  - `src/edison/data/commands/plan/plan-refine.md` (bounded questions + targeted edits, Spec‑Kit clarify style)

## Command Content Requirements (REQUIRED)

### Plan refine (`plan-refine.md`)

This command must adopt Spec‑Kit clarify principles:
- Ask at most 5 high-impact questions total (hard cap).
- After each answer, propose targeted edits only (do not rewrite the whole plan).
- If drift impacts generated tasks, it must explicitly recommend running `plan-analyze` and then `plan-sync-tasks` (read-only) before any regeneration.

### Plan sync tasks (`plan-sync-tasks.md`)

This command must be approval-gated and conservative:
- Always start with a read-only drift summary (what changed, why it matters).
- Propose a minimal set of task updates:
  - add missing tasks
  - update dependencies
  - update wave hints / locks if needed
- It must never propose “rewrite every task”; instead it must produce a small patch plan and ask for approval.

## Acceptance Criteria

- [ ] Drift is detected deterministically and surfaced clearly.
- [ ] Regeneration never silently creates duplicate/competing task sets.
- [ ] Sync workflows are approval-gated and minimize edits (targeted diffs).
- [ ] Outputs follow OpenSpec-style validator UX: structured JSON (for CLIs), and clear next steps.
- [ ] Drift handling is fail-closed by default: users must explicitly opt into regenerating/syncing when drift exists.

## Files to Create/Modify

```
# Add (slash commands; CLI planned for later implementation work)
src/edison/data/commands/plan/plan-sync-tasks.md
src/edison/data/commands/plan/plan-refine.md
```

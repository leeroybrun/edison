---
id: "26.3-wave1-workflow-plan-state-machine"
title: "Add plan state machine (draft→approved→archived) and WorkflowConfig support"
type: feature
owner:
session_id:
parent_id:
child_ids:
depends_on:
blocks_tasks:
related:
  - "26.1-wave1-meta-share-plans"
claimed_at:
last_active:
continuation_id:
created_at: "2025-12-28T00:00:00Z"
updated_at: "2025-12-28T00:00:00Z"
tags:
  - plan-mode
  - workflow
priority: high
estimated_hours:
model:
---

# Add plan state machine (draft→approved→archived) and WorkflowConfig support

## Summary

Add a new `plan` entity to Edison’s unified workflow state machine and ensure `WorkflowConfig` can serve plan states/transitions like it does for task/qa/session.

This is mandatory to avoid duplicating transition logic and to keep plan lifecycle coherent with the rest of Edison.

## Required Reading

- `.project/plans/plan-1-plan-mode.md`
- `src/edison/data/config/workflow.yaml` (statemachine.*)
- `src/edison/core/config/domains/workflow.py` (get_states + get_initial_state)
- `src/edison/core/entity/repository.py` (BaseRepository.transition)

## Objectives

- [ ] Add `workflow.statemachine.plan.states` to config:
  - `draft` initial
  - `approved`
  - `archived` final
- [ ] Extend `WorkflowConfig` to:
  - return plan states via `get_states("plan")`
  - allow `get_initial_state("plan")` to work
  - keep existing behavior for task/qa/session unchanged

## Acceptance Criteria

- [ ] `WorkflowConfig.get_states("plan")` returns the configured list.
- [ ] `WorkflowConfig.get_initial_state("plan")` returns `draft`.
- [ ] PlanRepository (task 26.2) can call workflow config to discover states and initial state.
- [ ] `transition_entity(entity_type="plan", ...)` can validate transitions using the new config.

## Technical Design

### State machine
In `src/edison/data/config/workflow.yaml`:
- Add:
  - `statemachine.plan.states.draft.initial: true`
  - `statemachine.plan.states.archived.final: true`
  - Transitions:
    - draft → approved (guard: always_allow; rules: fail-closed optional)
    - approved → archived (guard: always_allow)
    - (optional) approved → draft (only if you want “unapprove”; default: no)

### WorkflowConfig changes
Current `WorkflowConfig` hardcodes the allowed domains in `get_states(...)`.
Add:
- `plan_states` cached property similar to session_states.
- `get_states("plan")` branch.
- Update `get_final_state` and `get_final_states` to accept `plan` (if needed).

## Files to Modify

```
# Modify
src/edison/data/config/workflow.yaml
src/edison/core/config/domains/workflow.py
```

## Verification

- [ ] Unit tests for WorkflowConfig plan state support
- [ ] Unit/integration test: PlanRepository.transition(draft→approved) succeeds
related:
  - "26.2-wave1-plan-domain-core"

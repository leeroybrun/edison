---
id: "26.7-wave3-plan-spec-validate-and-similarity"
title: "Plan Spec parser + plan validate (deps, structure, dupes, parallelism hints)"
type: feature
owner:
session_id:
parent_id:
child_ids:
depends_on:
  - "26.2-wave1-plan-domain-core"
  - "26.4-wave1-plan-cli-core"
blocks_tasks:
related:
  - "26.1-wave1-meta-share-plans"
claimed_at:
last_active:
continuation_id:
created_at: "2025-12-28T00:00:00Z"
updated_at: "2025-12-28T00:00:00Z"
tags:
  - plan-mode
  - validation
priority: high
estimated_hours:
model:
---

# Plan Spec parser + plan validate (deps, structure, dupes, parallelism hints)

## Summary

Implement the Plan Spec parser and a `edison plan validate` CLI that:
- extracts the `yaml edison-plan` block,
- validates required structure,
- validates internal dependencies (`depends_on_keys`),
- checks for likely duplicate existing tasks (deterministic similarity, optional semantic assist),
- emits parallelism guidance hints (suggested `resource_locks` or “possible file overlap” warnings).

## Required Reading

- `.project/plans/plan-1-plan-mode.md`
- `src/edison/core/task/similarity.py` (TaskSimilarityIndex)
- `src/edison/core/memory/manager.py` (semantic assist, fail-open)
- `src/edison/cli/task/similar.py` patterns

## Objectives

- [ ] Add `edison.core.plan.spec` to parse a single fenced block: ```yaml edison-plan```.
- [ ] Add `edison.core.plan.validate` to run validation and return a structured result.
- [ ] Add CLI: `edison plan validate <plan-id> [--json]`.
- [ ] Add config: `plans.similarity.*` overrides (default to tasks similarity settings when missing).

## Acceptance Criteria

- [ ] `plan validate` fails with a clear message when:
  - no Plan Spec block exists,
  - multiple blocks exist (unless explicitly supported),
  - required keys are missing,
  - dependency keys reference unknown keys.
- [ ] `plan validate` surfaces likely duplicates with scores and task ids (warn-only by default).
- [ ] Validation output is deterministic and stable under repeated runs.
- [ ] UX matches OpenSpec validator principles:
  - non-zero exit code when `ok=false`
  - “Next steps” guidance in text mode for common failures (missing block, unknown deps, duplicates)
  - stable ordering of `errors`/`warnings` (no nondeterministic ordering)

## Output Contract (JSON)

`edison plan validate --json` must return a single object:
- `id`: plan id
- `state`: plan state
- `ok`: boolean
- `errors`: list of `{code, message, location?}`
- `warnings`: list of `{code, message, location?}`
- `spec`: summary `{version, taskCount, waves}` (do not echo the full spec by default)
- `duplicates`: list of:
  - `{key, title, matches: [{taskId, score, title, state}] }`
- `parallelismHints`: list of:
  - `{wave, aKey, bKey, reason, suggestion}` (e.g. suggest resource_lock)
- `nextSteps`: list of strings (optional but recommended for text-mode parity)

## Technical Design

### Spec parsing
- Locate a fenced code block that starts with: ```yaml edison-plan
- Parse YAML content; return dict with source location info (for targeted edits later).

### Dedupe
For each spec task:
- Build query: `title + "\\n" + (short description)` (bounded).
- Run TaskSimilarityIndex.search(query, threshold=..., top_k=...).
- Optionally include semantic-assisted expansions if enabled in tasks config, but:
  - must remain fail-open (memory failures do not break validation),
  - final matches are still TaskSimilarityIndex results.

### Parallelism hints
If spec includes `file_targets`, detect overlap between tasks in the same wave:
- Emit warnings like “wave 1 tasks A and B both target src/foo.py; consider depends_on or shared resource_lock”.
Do not auto-add dependencies.

## Files to Create/Modify

```
# Add
src/edison/core/plan/spec.py
src/edison/core/plan/validate.py
src/edison/cli/plan/validate.py
src/edison/data/config/plans.yaml
```

## Verification

- [ ] Unit tests for parsing + validation and duplicate detection output

## Test Cases (minimum)

- [ ] Missing fenced block → ok=false with actionable error
- [ ] Duplicate keys in tasks list → ok=false
- [ ] depends_on_keys references missing key → ok=false
- [ ] Duplicates are surfaced but do not block by default (warn-only)
related:
  - "26.2-wave1-plan-domain-core"

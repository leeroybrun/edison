---
id: "26.6-wave2-task-planner-lock-batching-and-plan-cluster"
title: "Enhance task planner: resource_locks batching + plan clustering"
type: feature
owner:
session_id:
parent_id:
child_ids:
depends_on:
  - "26.5-wave2-task-plan-id-and-resource-locks"
blocks_tasks:
related:
  - "26.1-wave1-meta-share-plans"
claimed_at:
last_active:
continuation_id:
created_at: "2025-12-28T00:00:00Z"
updated_at: "2025-12-28T00:00:00Z"
tags:
  - plan-mode
  - planning
priority: high
estimated_hours:
model:
---

# Enhance task planner: resource_locks batching + plan clustering

## Summary

Extend `edison task plan` so orchestrators get better parallelism guidance:
1) Keep existing **hard dependency** scheduling into waves via `depends_on`.
2) Add **soft conflict** batch suggestions inside waves using `resource_locks`.
3) Improve within-wave task ordering/grouping by also clustering tasks by `plan_id` (in addition to `related`).

## Required Reading

- `.project/plans/plan-1-plan-mode.md`
- `src/edison/core/task/planning.py` and `src/edison/cli/task/plan.py`
- `src/edison/core/task/models.py` / TaskSummary fields

## Objectives

- [ ] Extend TaskPlanner output schema to include lock-safe batch suggestions (deterministic).
- [ ] Update CLI `edison task plan` to surface batches (text + json).
- [ ] Update ordering heuristic to cluster by `plan_id` (so plan tasks group even if the related anchor isn’t in-wave).
- [ ] Add tests for deterministic batching and clustering.

## Acceptance Criteria

- [ ] Given a wave of tasks with overlapping `resource_locks`, planner produces batches that do not contain conflicts.
- [ ] Batches respect max concurrency cap (existing behavior).
- [ ] Within-wave ordering is deterministic and groups tasks from the same plan together when possible.

## Technical Design

### Batching algorithm (deterministic)
Input: tasks in a wave (already “ready” by hard deps).
Goal: produce batches such that within each batch, no two tasks share a lock.
Constraints:
- Deterministic output (stable ordering).
- Prefer keeping tasks with no locks flexible.

Suggested approach:
- Sort tasks by (lock_count desc, task_id asc).
- Greedy pack into batches:
  - For each task in order, place it into the first batch where it doesn’t conflict.
  - Otherwise start a new batch.

### Output shape (backwards compatible)

Keep existing JSON keys:
- `waves`: list of waves with `tasks` (id/title/state)
- `blocked`: list
- existing `batches` (cap-based) remains

Add new keys (do not break existing consumers):
- `lockBatches`: list of batches per wave that are conflict-free by `resource_locks`
  - `[{ "wave": 1, "batch": 1, "tasks": [...], "locks": ["..."] }]`

Text mode:
- keep current “Batch suggestions (respect cap)” section
- add optional “Lock-safe batch suggestions” section when locks are present

### Clustering by plan_id
Augment existing `_order_wave_tasks`:
- Build connectivity edges not only from `related`, but also by grouping tasks with same non-empty `plan_id`.
- Keep union-find deterministic.

## Files to Modify

```
# Modify
src/edison/core/task/planning.py
src/edison/cli/task/plan.py
```

## Verification

- [ ] Unit tests for TaskPlanner batching + clustering
- [ ] Snapshot-style tests for deterministic output

## Test Cases (minimum)

- [ ] Two tasks with same lock never appear in same lockBatch
- [ ] Tasks with no locks can be placed anywhere without breaking determinism
- [ ] plan_id clustering groups tasks with same plan_id when multiple are present in a wave
related:
  - "26.2-wave1-plan-domain-core"

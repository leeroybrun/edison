---
id: "26.4-wave1-plan-cli-core"
title: "Plan CLI v1: allocate-id, new, list/show, approve"
type: feature
owner:
session_id:
parent_id:
child_ids:
depends_on:
  - "26.2-wave1-plan-domain-core"
  - "26.3-wave1-workflow-plan-state-machine"
blocks_tasks:
related:
  - "26.1-wave1-meta-share-plans"
claimed_at:
last_active:
continuation_id:
created_at: "2025-12-28T00:00:00Z"
updated_at: "2025-12-28T00:00:00Z"
tags:
  - plan-mode
  - cli
priority: high
estimated_hours:
model:
---

# Plan CLI v1: allocate-id, new, list/show, approve

## Summary

Add a new CLI domain `edison plan` with the core commands needed to create and manage plan files:
- `allocate-id`
- `new`
- `list`
- `show`
- `approve` (state transition)

These commands must follow Edisonâ€™s CLI conventions: deterministic output, `--json` option, and repo-root resolution via `add_repo_root_flag`.

## Required Reading

- `.project/plans/plan-1-plan-mode.md`
- `src/edison/cli/_dispatcher.py` (auto-discovery)
- `src/edison/cli/task/*.py` patterns (register_args/main/OutputFormatter)
- `src/edison/core/plan/repository.py` (PlanRepository API)

## Objectives

- [ ] Create `src/edison/cli/plan/` domain folder with commands.
- [ ] Add `edison plan allocate-id` that scans `.project/plans/*/*.md` and returns next `plan-<n>`.
- [ ] Add `edison plan new` that creates a draft plan file from composed template and sets title.
- [ ] Add `edison plan list` and `edison plan show`.
- [ ] Add `edison plan approve` which transitions plan to `approved` using repository.transition.

## Acceptance Criteria

- [ ] `edison plan allocate-id --json` returns `{ "nextId": "plan-<n>" }`.
- [ ] `edison plan new --id <n> --slug <slug>` creates `.project/plans/draft/plan-<n>-<slug>.md`.
- [ ] `edison plan list` shows draft/approved/archived plans.
- [ ] `edison plan approve <plan-id>` moves plan file to `.project/plans/approved/`.
- [ ] OpenSpec-style CLI ergonomics:
  - on invalid usage in non-interactive mode, print a clear hint (what to run next) and exit non-zero
  - JSON mode prints a single object with stable keys

## CLI Contract (must be stable)

### `edison plan allocate-id`

- Text:
  - `Next available ID: plan-<n>`
- JSON:
  - `{ "nextId": "plan-<n>" }`

### `edison plan new --id <n> --slug <slug> [--title <title>] [--owner <owner>]`

- Text:
  - `Created plan: plan-<n>-<slug> (draft)`
  - `  @.project/plans/draft/plan-<n>-<slug>.md`
- JSON:
  - `{ "status": "created", "plan_id": "...", "state": "draft", "path": "..." }`

### `edison plan list [--state <draft|approved|archived>]`

- Text:
  - one plan per line: `<plan-id>  <state>  <title>`
- JSON:
  - `{ "plans": [{ "id": "...", "state": "...", "title": "...", "path": "..." }] }`

### `edison plan show <plan-id>`

- Text: human-friendly summary with resolved path.
- JSON:
  - `{ "id": "...", "state": "...", "title": "...", "path": "...", "owners": [...], "task_id_prefix": "...", "generated_task_ids": [...] }`

### `edison plan approve <plan-id>`

- Text:
  - `Approved plan: <plan-id> (draft -> approved)`
- JSON:
  - `{ "status": "approved", "id": "...", "from": "draft", "to": "approved", "path": "..." }`

## Technical Design

### Plan ID allocation
- Implement similar to `edison task allocate-id`:
  - find max numeric prefix across existing plan IDs
  - next = max + 1
- Plan id format: `plan-<n>-<slug>` (slug provided by user, not inferred).

### New plan file creation
Use PlanRepository + template rendering:
- PlanRepository should render body from `.edison/_generated/documents/PLAN.md` (fallback to bundled template).
- `edison plan new` should set frontmatter fields:
  - `id`, `title`, `owners` (optional), metadata timestamps (via EntityMetadata)

### Approve
- `approve` uses repository.transition(plan_id, "approved", context=...) to reuse unified guards/rules.

## Files to Create/Modify

```
# Add
src/edison/cli/plan/__init__.py
src/edison/cli/plan/allocate_id.py
src/edison/cli/plan/new.py
src/edison/cli/plan/list.py
src/edison/cli/plan/show.py
src/edison/cli/plan/approve.py
```

## Verification

- [ ] Unit tests for allocate-id and new/approve path behavior
- [ ] E2E smoke: run the CLIs in a temp repo root and verify files created/moved

## Test Cases (minimum)

- [ ] allocate-id skips non-matching filenames and handles empty folder
- [ ] new refuses invalid slug (empty/whitespace), normalizes safely if needed
- [ ] approve fails closed when plan not found
- [ ] approve fails closed when plan already approved (unless explicitly supported)
related:
  - "26.2-wave1-plan-domain-core"

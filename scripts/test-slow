#!/usr/bin/env bash
set -euo pipefail

# Run the slow test suite in parallel when pytest-xdist is available.
#
# Usage:
#   scripts/test-slow            # parallel (if xdist installed)
#   scripts/test-slow -k foo     # pass-through args
#
# If you want a single-process run, pass `-n 0`.

py="python3"
if [[ -x ".venv/bin/python" ]]; then
  py=".venv/bin/python"
fi

has_n_flag=0
for a in "$@"; do
  if [[ "$a" == "-n" || "$a" == "--numprocesses" || "$a" == "--dist" ]]; then
    has_n_flag=1
    break
  fi
done

if [[ "$has_n_flag" -eq 0 ]]; then
  if "$py" -c "import xdist" >/dev/null 2>&1; then
    exec "$py" -m pytest -m slow -n auto --dist loadfile "$@"
  fi
fi

exec "$py" -m pytest -m slow "$@"

# Worktree Configuration
# Git worktree management for session isolation

worktrees:
  enabled: true
  baseBranchMode: "current"
  baseBranch: null
  baseDirectory: "../{PROJECT_NAME}-worktrees"
  archiveDirectory: "../{PROJECT_NAME}-worktrees/_archived"
  branchPrefix: "session/"
  pathTemplate: "../{PROJECT_NAME}-worktrees/{sessionId}"
  sharedState:
    # Controls how `.project/*` and `.edison/_generated` are shared across session worktrees.
    # Git worktrees do not share untracked/ignored files, so a shared root keeps tasks/QA/session
    # metadata consistent regardless of the current session worktree.
    #
    # Modes:
    # - meta: Use a dedicated git worktree (default) at `metaPathTemplate` on `metaBranch`.
    # - primary: Use the primary checkout as the shared root.
    # - external: Use an explicit filesystem path (`externalPath`) as the shared root.
    mode: "meta"
    metaBranch: "edison-meta"
    metaPathTemplate: "../{PROJECT_NAME}-worktrees/_meta"
    # Additional repo-root relative paths to share via symlink into worktrees.
    #
    # This is intended for untracked "project meta" that should be shared across all
    # worktrees regardless of code branch (e.g. OpenSpec/Speckit state).
    #
    # IMPORTANT: Edison will NOT replace tracked paths with symlinks. If a path is
    # tracked on the code branch, it will be skipped (and must be migrated manually).
    #
    # Each entry supports:
    # - path: repo-root relative path (no absolute paths / no `..`)
    # - scopes: ["session"] (default), or ["primary","session"] to also link in primary
    # - type: "dir" (default) or "file"
    # - targetRoot: "shared" (default) or "primary"
    # - mergeExisting: true (default) to merge existing untracked content into the shared target
    # Recommended defaults for worktree meta/shared setups.
    # Projects can append additional items via:
    #   sharedPaths: ["+", {path: "foo", scopes: ["primary","session"]}]
    # Projects can disable a default by appending:
    #   sharedPaths: ["+", {path: ".pal", enabled: false}]
    sharedPaths:
      # Project management state (meta-managed).
      # Commit policy default: tasks + qa + sessions are committable; logs/archive are not.
      - path: ".project/tasks"
        scopes: ["primary", "session"]
        commitAllowed: true
      - path: ".project/qa"
        scopes: ["primary", "session"]
        commitAllowed: true
      - path: ".project/sessions"
        scopes: ["primary", "session"]
        commitAllowed: true
      - path: ".project/logs"
        scopes: ["primary", "session"]
        commitAllowed: false
      - path: ".project/archive"
        scopes: ["primary", "session"]
        commitAllowed: false

      # Composed artifacts (meta-managed, never committed).
      - path: ".edison/_generated"
        scopes: ["primary", "session"]
        commitAllowed: false

      - path: ".specify"
        scopes: ["primary", "session"]
      - path: "specs"
        scopes: ["primary", "session"]
      - path: ".openspec"
        scopes: ["primary", "session"]
      - path: ".claude"
        scopes: ["primary", "session"]
      - path: ".codex"
        scopes: ["primary", "session"]
        # Codex stores runtime state here (auth/history/logs). Do not allow committing
        # the directory as a whole, but allow prompts to be tracked.
        commitAllowed: false
        commitAllowPrefixes:
          - ".codex/prompts/"
      - path: ".augment"
        scopes: ["primary", "session"]
      - path: ".cursor"
        scopes: ["primary", "session"]
      - path: ".pal"
        scopes: ["primary", "session"]
      # `.edison/config/*` stays tracked as a bootstrap config source.
      - path: ".edison/agents"
        scopes: ["primary", "session"]
      - path: ".edison/validators"
        scopes: ["primary", "session"]
      - path: ".edison/guidelines"
        scopes: ["primary", "session"]
      - path: ".edison/constitutions"
        scopes: ["primary", "session"]
      - path: ".edison/scripts"
        scopes: ["primary", "session"]
    # Worktree-local git excludes to avoid cross-branch status noise. These are written to
    # each checkout via per-worktree `core.excludesFile`, not repo `.gitignore`.
    gitExcludes:
      primary:
        - ".project/"
        - ".edison/_generated/"
      session:
        - ".project/"
        - ".edison/_generated/"
      meta:
        - ".project/logs/"
        - ".project/archive/"
        - ".edison/_generated/"
        - ".edison/_generated.__tmp__*"
        # Ignore Codex runtime noise in meta, but keep prompts visible/trackable.
        - ".codex/*"
        - "!.codex/prompts/"
        - "!.codex/prompts/**"
        # Ignore Edison-generated command files (they can always be regenerated).
        - ".claude/commands/edison.*.md"
        - ".cursor/commands/edison.*.md"
        # OS/editor noise
        - ".DS_Store"
        - "*.bak"
    # Guard against accidental commits of code changes on the meta branch.
    commitGuard:
      enabled: true
      allowPrefixes: []
    # When true, ensures `.project/qa/validation-evidence/` resolves to a
    # single canonical location shared across primary checkout, session
    # worktrees, and meta worktree. This prevents "missing evidence" errors
    # when operators write evidence in one worktree but run guards from another.
    # Default: false (for backward compatibility).
    shareEvidenceRoot: false
  installDeps: false
  postInstallCommands: []
  enableDatabaseIsolation: false
  autoCleanupOnMerge: false
  enforcement:
    enabled: true
    commands:
      - "session close"
      - "session next"
      - "session status"
      - "session track"
      - "session verify"
      - "session complete"
      - "session validate"
      - "task claim"
      - "task status"
      - "task mark-delegated"
      - "task split"
      - "task link"
      - "qa validate"
      - "qa run"
      - "qa bundle"
      - "qa promote"
  cleanup:
    autoArchive: true
    archiveAfterDays: 30
    deleteAfterDays: 90

statemachine:
  task:
    states:
      todo:
        description: "Task awaiting claim"
        initial: true
        allowed_transitions:
          - to: wip
            guard: can_start_task
            conditions:
              - name: task_claimed
          - to: done
            guard: can_finish_task
            conditions:
              - name: all_work_complete
              - name: no_pending_commits
            actions:
              - name: record_completion_time
          - to: blocked
            guard: has_blockers
            actions:
              - name: record_blocker_reason
      wip:
        description: "Task in progress"
        allowed_transitions:
          - to: blocked
            guard: has_blockers
            actions:
              - name: record_blocker_reason
          - to: done
            guard: can_finish_task
            conditions:
              - name: all_work_complete
              - name: no_pending_commits
            actions:
              - name: record_completion_time
          - to: todo
            guard: always_allow
          - to: validated
            guard: always_allow
      blocked:
        description: "Waiting on external blockers"
        allowed_transitions:
          - to: wip
            guard: can_start_task
          - to: todo
            guard: always_allow
      done:
        description: "Implementation complete, awaiting validation"
        allowed_transitions:
          - to: validated
            guard: can_finish_task
          - to: wip
            guard: always_allow
      validated:
        description: "Validated and complete"
        final: true
        allowed_transitions: []

  qa:
    states:
      waiting:
        initial: true
        description: "Pending hand-off from implementation"
        allowed_transitions:
          - to: todo
            guard: always_allow
          - to: wip
            guard: always_allow
      todo:
        description: "QA backlog"
        allowed_transitions:
          - to: wip
            guard: always_allow
      wip:
        description: "QA in progress"
        allowed_transitions:
          - to: done
            guard: always_allow
          - to: todo
            guard: always_allow
      done:
        description: "QA review complete"
        allowed_transitions:
          - to: validated
            guard: always_allow
          - to: wip
            guard: always_allow
      validated:
        description: "QA validated"
        final: true
        allowed_transitions: []

  session:
    states:
      draft:
        description: "Session in draft state, not yet active"
        allowed_transitions:
          - to: active
            guard: can_activate_session
            conditions:
              - name: has_task
                error: "Session must have a linked task"
              - name: task_claimed
                error: "Task must be claimed before activating session"
            actions:
              - name: create_worktree
                when: config.worktrees_enabled
              - name: record_activation_time
              - name: notify_session_start
      active:
        description: "Session is active, work in progress"
        initial: true
        allowed_transitions:
          - to: done
            guard: can_complete_session
            conditions:
              - name: all_work_complete
              - name: no_pending_commits
            actions:
              - name: finalize_session
              - name: record_completion_time
          - to: blocked
            guard: has_blockers
            conditions:
              - name: validation_failed
                or:
                  - name: dependencies_missing
            actions:
              - name: record_blocker_reason
          - to: closing
            guard: can_complete_session
            conditions:
              - name: ready_to_close
            actions:
              - name: finalize_session
          - to: recovery
            guard: always_allow
      blocked:
        description: "Session blocked due to validation or dependencies"
        allowed_transitions:
          - to: active
            guard: can_activate_session
            conditions:
              - name: has_blocker_reason
      done:
        description: "Session work complete"
        allowed_transitions:
          - to: validated
            guard: can_complete_session
            actions:
              - name: record_completion_time
      closing:
        description: "Session closing and awaiting validation"
        allowed_transitions:
          - to: validated
            guard: can_complete_session
            conditions:
              - name: ready_to_close
            actions:
              - name: record_closed
          - to: recovery
            guard: always_allow
      validated:
        description: "Session validated"
        allowed_transitions:
          - to: archived
            guard: always_allow

      recovery:
        description: "Session in recovery after timeout or failure"
        allowed_transitions:
          - to: active
            guard: always_allow
          - to: closing
            guard: always_allow

      archived:
        description: "Session archived"
        final: true
        allowed_transitions: []

# Edison Core Hooks Configuration
# Claude Code hooks for workflow enforcement and context injection

hooks:
  enabled: true
  platforms: [claude]  # Only Claude Code supports hooks

  # Global hook settings
  settings:
    timeout_seconds: 60
    parallel_execution: true
    log_output: true
    # Project-wide hook execution scope (default: session-gated).
    # - session: run hooks only when an Edison session is detected
    # - project: run hooks whenever inside a configured Edison project
    # - always: always run hooks (least restrictive)
    executionScope: session

  # Hook definitions
  definitions:
    # ===== Context Injection Hooks (UserPromptSubmit) =====

    inject-session-context:
      type: UserPromptSubmit
      hook_type: prompt
      enabled: true
      description: "Inject `edison session context` output before prompt"
      template: "inject-session-context.sh.template"
      config:
        max_length: 500

    inject-task-rules:
      type: UserPromptSubmit
      hook_type: prompt
      enabled: true
      description: "Inject Edison-rendered rules for current task state"
      template: "inject-task-rules.sh.template"
      config:
        # Core must remain tech-agnostic. Packs/projects may narrow this.
        # "*" means the hook can apply regardless of stack (if enabled/configured).
        file_patterns:
          - "*"
        # Rules are now resolved via `edison rules inject --transition` API.
        # The hook maps task state to workflow transitions (e.g., wip -> "wip->done").
        # Transition rules are defined in workflow.yaml, not here.

    # ===== Reminder Hooks (PreToolUse - NON-BLOCKING) =====

    remind-tdd:
      type: PreToolUse
      hook_type: command
      matcher: "Write|Edit"
      enabled: true
      blocking: false  # Just reminds, doesn't block
      description: "Remind about TDD workflow when editing code"
      template: "remind-tdd.sh.template"
      config:
        only_for_states: [wip]
        skip_test_files: true

    remind-state-machine:
      type: PreToolUse
      hook_type: command
      matcher: "*"
      enabled: false  # Disabled by default (too chatty)
      blocking: false
      description: "Remind about current state constraints"
      template: "remind-state-machine.sh.template"
      config:
        only_for_states: [wip, done]

    # ===== Guard Hooks (PreToolUse - CAN BLOCK) =====

    enforce-worktree:
      type: PreToolUse
      hook_type: command
      matcher: "Write|Edit|Glob|Grep|Bash"
      enabled: true
      blocking: true
      description: "Block tool use outside the active session worktree"
      template: "enforce-worktree.sh.template"
      config:
        # Allow safe/required Bash prefixes even when not in the worktree.
        allow_bash_prefixes:
          - "edison"
          - "uv run edison"
          - "python -m edison"
          - "python3 -m edison"
        # Allow shell builtins / harmless reads to run so the agent can recover.
        allow_bash_commands:
          - "cd"
          - "pwd"
          - "ls"
          - "cat"
          - "echo"

    commit-guard:
      type: PreToolUse
      hook_type: command
      matcher: "Bash(git commit:*)"
      enabled: true
      blocking: true  # CAN BLOCK
      description: "Block commits with failing tests or low coverage"
      template: "commit-guard.sh.template"
      config:
        require_tests_pass: true
        require_coverage: true
        # Default coverage threshold comes from config.quality.coverage.overall.

    prevent-destructive-git:
      type: PreToolUse
      hook_type: command
      matcher: "*"
      enabled: true
      blocking: true
      description: "Block destructive git commands unless explicitly approved"
      template: "prevent-destructive-git.sh.template"
      config:
        # Allow bypass only when the user explicitly asked to run destructive git commands.
        allow_env: "EDISON_ALLOW_DESTRUCTIVE_GIT"
        # Patterns (simple substring checks) treated as destructive.
        patterns:
          - "git reset"
          - "git restore"
          - "git clean"
          - "git checkout --"
          - "git switch"

    enforce-edison-exec:
      type: PreToolUse
      hook_type: command
      matcher: "*"
      enabled: false  # Project may enable to enforce `edison exec` wrapper for Bash tool commands
      blocking: true
      description: "Enforce `edison exec` for non-Edison Bash commands (audit + shims)"
      template: "enforce-edison-exec.sh.template"
      config:
        # Allow bypass only when the user explicitly asked to run direct shell commands.
        allow_env: "EDISON_ALLOW_DIRECT_BASH"
        # Allow bare shell builtins that cannot be reliably wrapped (e.g. `cd` affects the parent shell).
        allow_builtins:
          - "cd"
          - "export"
          - "unset"
          - "source"
          - "eval"
        # Allowed Edison invocations (prefixes). These are NOT required to go through `edison exec`.
        allow_edison_prefixes:
          - "edison"
          - "uv run edison"
          - "python -m edison"
          - "python3 -m edison"

    prevent-prod-edits:
      type: PreToolUse
      hook_type: command
      matcher: "Write|Edit"
      enabled: false  # Disabled by default
      blocking: true
      description: "Block edits to production files"
      template: "prevent-prod-edits.sh.template"
      config:
        protected_patterns:
          - "*.prod.*"
          - "production/*"

    non-interactive-guard:
      type: PreToolUse
      hook_type: command
      matcher: "Bash"
      enabled: false  # Optional - disabled by default (conservative)
      blocking: true  # CAN BLOCK if onMatch is configured to "block"
      description: "Warn or block interactive commands that may hang in non-interactive environments"
      template: "non-interactive-guard.sh.template"
      config:
        # Behavior is controlled by execution.nonInteractive config section.
        # onMatch: warn (print warning, allow command) or block (exit non-zero)
        # bannedCommandPatterns: list of patterns to match
        # env: dict of env vars to recommend (informational)

    # ===== Validation Hooks (PostToolUse) =====

    check-tests:
      type: PostToolUse
      hook_type: command
      matcher: "Write|Edit"
      enabled: false  # Optional
      blocking: false
      description: "Check if tests exist after code edit"
      template: "check-tests.sh.template"
      config:
        warn_if_missing: true
        skip_test_files: true

    auto-format:
      type: PostToolUse
      hook_type: command
      matcher: "Write|Edit"
      enabled: false
      blocking: false
      description: "Auto-format code after modifications"
      template: "auto-format.sh.template"
      config:
        # Core is tech-agnostic. Packs/projects provide formatter tools and file patterns.
        tools: []
        file_patterns: []

    # ===== Session Lifecycle Hooks =====

    session-init:
      type: SessionStart
      hook_type: command
      enabled: true
      blocking: false
      description: "Initialize session context"
      template: "session-init.sh.template"
      config:
        show_welcome: true

    session-cleanup:
      type: SessionEnd
      hook_type: command
      enabled: true
      blocking: false
      description: "Cleanup session resources"
      template: "session-cleanup.sh.template"
      config:
        save_logs: true
        run_memory_pipeline: false
        memory_pipeline_event: "session-end"
        memory_best_effort: true

    # ===== Context Compaction Hooks (PreCompact) =====

    compaction-reminder:
      type: PreCompact
      hook_type: command
      enabled: true
      blocking: false
      description: "Emit session context (with Actor identity) for compaction recovery"
      template: "compaction-reminder.sh.template"
      config:
        # Notify controls whether the directive reminder is printed.
        # The Actor stanza in session context provides the exact `edison read` command.
        notify: true

    # ===== Stop Hooks =====

    stop-continuation:
      type: Stop
      hook_type: command
      enabled: true
      blocking: false  # Fail-open: never block, even if Edison is unavailable
      description: "Inject continuation nudge when session is incomplete (FC/RL assist)"
      template: "stop-continuation.sh.template"
      config:
        # Show "complete" line when session is complete (minimal output)
        show_complete_line: true
        # Emit CWAM reassurance line at stop (when enabled in context_window config)
        emit_cwam: true

    stop-validate:
      type: Stop
      hook_type: command
      enabled: false  # Optional
      blocking: false
      description: "Validate work when agent stops"
      template: "stop-validate.sh.template"
      config:
        run_quick_validation: true

# =============================================================================
# EDISON UNIFIED COMPOSITION CONFIGURATION
# =============================================================================
# This is the single source of truth for ALL composition settings.
# 
# All composition config is under the `composition:` key to ensure proper
# namespacing when merged with other config files.
#
# Structure:
#   composition:
#     defaults: Global composition defaults (dedupe, headers)
#     content_types: ALL composable content (agents, validators, roots, etc.)
#     adapters: Platform adapter configurations (claude, cursor, pal, etc.)
#
# Usage:
#   edison compose all              # Compose everything
#   edison compose all --agents     # Compose only agents
#   edison compose all --roots      # Compose root entry points (AGENTS.md/CLAUDE.md)
#   edison compose all --artifacts  # Compose artifact templates (TASK/QA/Report)
#   edison compose all --claude     # Compose + sync to Claude
# =============================================================================

composition:
  # ===========================================================================
  # DEFAULTS
  # ===========================================================================
  # Global settings applied to all content types unless overridden.

  defaults:
    # Deduplication settings (used by guidelines, start prompts)
    dedupe:
      shingle_size: 12
      min_shingles: 5
      threshold: 0.37

    # Default composition mode
    composition_mode: section_merge

    # Generated file header template
    generated_header: |
      <!--
        AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
        Generated by: Edison Framework {{version}}
        Template: {{template}}
        Project config root: {{PROJECT_EDISON_DIR}}
      
        To modify, edit the source template or configuration.
      -->

  # ===========================================================================
  # WRITE POLICIES
  # ===========================================================================
  # Controls how Edison writes generated files:
  # - replace: overwrite whole file
  # - markers: manage only a marker-delimited block (preserve manual edits outside)
  #
  # These defaults ensure shared instruction stubs (AGENTS.md / CLAUDE.md) can be
  # partially managed while allowing teams to keep additional manual context.
  write_policies:
    - id: instruction-files-managed-block
      globs:
        - "AGENTS.md"
        - "CLAUDE.md"
        - ".claude/CLAUDE.md"
      policy:
        mode: markers
        begin_marker: "<!-- EDISON:START -->"
        end_marker: "<!-- EDISON:END -->"
        on_missing: prepend

  # ===========================================================================
  # CONTENT TYPES
  # ===========================================================================
  # Every piece of composed content is defined here.
  # Each type can be composed via: edison compose <type>
  #
  # Common properties:
  #   enabled         - Whether to compose this type (default: true)
  #   description     - Human-readable description
  #   composition_mode - section_merge | concatenate | yaml_merge | json_merge
  #   dedupe          - Enable deduplication (default: false)
  #   registry        - Registry class name (null = GenericRegistry)
  #   content_path    - Source directory path, relative to data/ (default: type name)
  #   file_pattern    - Glob pattern for source files (default: "*.md")
  #   output_path     - Where composed files are written
  #   filename_pattern - Pattern for output filenames (default: "{name}.md")
  #   cli_flag        - CLI flag override (default: type name with _ -> -)

  content_types:
    # -------------------------------------------------------------------------
    # AGENTS
    # -------------------------------------------------------------------------
    agents:
      enabled: true
      description: "Agent prompt templates"
      composition_mode: section_merge
      dedupe: false
      registry: edison.core.composition.registries.agent_prompts.AgentPromptRegistry
      content_path: "agents"
      file_pattern: "*.md"
      output_path: "{{PROJECT_EDISON_DIR}}/_generated/agents"
      filename_pattern: "{name}.md"

    # -------------------------------------------------------------------------
    # VALIDATORS  
    # -------------------------------------------------------------------------
    validators:
      enabled: true
      description: "Validator prompt templates"
      composition_mode: section_merge
      dedupe: false
      registry: edison.core.composition.registries.validator_prompts.ValidatorPromptRegistry
      content_path: "validators"
      file_pattern: "*.md"
      output_path: "{{PROJECT_EDISON_DIR}}/_generated/validators"
      filename_pattern: "{name}.md"

    # -------------------------------------------------------------------------
    # GUIDELINES
    # -------------------------------------------------------------------------
    guidelines:
      enabled: true
      description: "Guideline documents"
      composition_mode: concatenate
      dedupe: true
      registry: null  # Use GenericRegistry (unified composition engine)
      content_path: "guidelines"
      file_pattern: "*.md"
      output_path: "{{PROJECT_EDISON_DIR}}/_generated/guidelines"
      filename_pattern: "{name}.md"

    # -------------------------------------------------------------------------
    # CONSTITUTIONS
    # -------------------------------------------------------------------------
    constitutions:
      enabled: true
      description: "Role constitutions (orchestrators, agents, validators)"
      composition_mode: section_merge
      dedupe: false
      registry: edison.core.composition.registries.constitutions.ConstitutionRegistry
      content_path: "constitutions"
      file_pattern: "*.md"
      output_path: "{{PROJECT_EDISON_DIR}}/_generated/constitutions"
      filename_pattern: "{NAME}.md"

    # -------------------------------------------------------------------------
    # ROOTS (Entry Points: AGENTS.md, CLAUDE.md)
    # -------------------------------------------------------------------------
    roots:
      enabled: true
      description: "Root entry point files"
      composition_mode: section_merge
      dedupe: false
      registry: null
      content_path: "roots"
      file_pattern: "*.md"
      output_path: "."
      filename_pattern: "{NAME}.md"
      output_mapping:
        CLAUDE: ".claude/CLAUDE.md"

    # -------------------------------------------------------------------------
    # START (Session Start Prompts)
    # -------------------------------------------------------------------------
    start:
      enabled: true
      description: "Session start prompts"
      composition_mode: concatenate
      dedupe: true
      registry: null
      content_path: "start"
      file_pattern: "*.md"
      output_path: "{{PROJECT_EDISON_DIR}}/_generated/start"
      filename_pattern: "{name}.md"

    # -------------------------------------------------------------------------
    # CURSOR RULES (.mdc files)
    # -------------------------------------------------------------------------
    cursor_rules:
      enabled: true
      description: "Cursor IDE rules"
      composition_mode: section_merge
      dedupe: false
      registry: null
      content_path: "clients/cursor/rules"
      file_pattern: "*.mdc"
      output_path: ".cursor/rules"
      filename_pattern: "{name}.mdc"
      cli_flag: "cursor-rules"

    # -------------------------------------------------------------------------
    # SCHEMAS (JSON Schema expressed in YAML)
    # -------------------------------------------------------------------------
    schemas:
      enabled: true
      description: "Schemas (YAML; JSON Schema expressed in YAML)"
      composition_mode: yaml_merge
      dedupe: false
      registry: edison.core.composition.registries.schemas.SchemaRegistry
      content_path: "schemas"
      file_pattern: "*.yaml"
      output_path: "{{PROJECT_EDISON_DIR}}/_generated/schemas"
      filename_pattern: "{name}.yaml"

    # -------------------------------------------------------------------------
    # TEMPLATES (Task/QA/Report scaffolds)
    # -------------------------------------------------------------------------
    artifacts:
      enabled: true
      description: "Artifact templates (TASK.md, QA.md, IMPLEMENTATION_REPORT.md)"
      composition_mode: section_merge
      dedupe: false
      registry: null  # Use GenericRegistry
      content_path: "templates/artifacts"
      file_pattern: "*.md"
      output_path: "{{PROJECT_EDISON_DIR}}/_generated/templates/artifacts"
      filename_pattern: "{name}.md"

    # -------------------------------------------------------------------------
    # ROSTERS (Data-driven documents)
    # -------------------------------------------------------------------------
    agent_roster:
      enabled: true
      description: "Available agents roster (AVAILABLE_AGENTS.md)"
      composition_mode: section_merge
      dedupe: false
      registry: edison.core.composition.generators.available_agents.AgentRosterGenerator
      content_path: "generators"
      file_pattern: "AVAILABLE_AGENTS.md"
      output_path: "{{PROJECT_EDISON_DIR}}/_generated"
      filename_pattern: "AVAILABLE_AGENTS.md"

    validator_roster:
      enabled: true
      description: "Available validators roster (AVAILABLE_VALIDATORS.md)"
      composition_mode: section_merge
      dedupe: false
      registry: edison.core.composition.generators.available_validators.ValidatorRosterGenerator
      content_path: "generators"
      file_pattern: "AVAILABLE_VALIDATORS.md"
      output_path: "{{PROJECT_EDISON_DIR}}/_generated"
      filename_pattern: "AVAILABLE_VALIDATORS.md"

    state_machine:
      enabled: true
      description: "State machine documentation (STATE_MACHINE.md)"
      composition_mode: section_merge
      dedupe: false
      registry: edison.core.composition.generators.state_machine.StateMachineGenerator
      content_path: "generators"
      file_pattern: "STATE_MACHINE.md"
      output_path: "{{PROJECT_EDISON_DIR}}/_generated"
      filename_pattern: "STATE_MACHINE.md"

  # ===========================================================================
  # PLATFORM ADAPTERS
  # ===========================================================================
  # Platform adapters handle syncing composed content to IDE/tool directories.
  # Each adapter is loaded dynamically via its adapter_class.
  #
  # Properties:
  #   enabled      - Whether this adapter is active
  #   adapter_class - Full Python module path to adapter class
  #   description  - Human-readable description
  #   sync         - Sync configuration (source -> destination mappings)

  adapters:
    # -------------------------------------------------------------------------
    # REPO (Repository hygiene: gitignore, etc.)
    # -------------------------------------------------------------------------
    managed-files:
      enabled: true
      adapter_class: edison.core.adapters.platforms.managed_files.ManagedFilesAdapter
      description: "Managed files (append-only edits to repo files)"
      output_path: "."

    # -------------------------------------------------------------------------
    # CLAUDE (Claude Code / Claude Desktop)
    # -------------------------------------------------------------------------
    claude:
      enabled: true
      adapter_class: edison.core.adapters.platforms.claude.ClaudeAdapter
      description: "Claude Code / Claude Desktop integration"
      output_path: ".claude"
      sync:
        agents:
          enabled: true
          source: "{{PROJECT_EDISON_DIR}}/_generated/agents"
          destination: ".claude/agents"
          filename_pattern: "{name}.md"

    # -------------------------------------------------------------------------
    # CURSOR (Cursor IDE)
    # -------------------------------------------------------------------------
    cursor:
      enabled: true
      adapter_class: edison.core.adapters.platforms.cursor.CursorAdapter
      description: "Cursor IDE integration"
      output_path: ".cursor"

    # -------------------------------------------------------------------------
    # PAL (Pal MCP / Cline)
    # -------------------------------------------------------------------------
    pal:
      enabled: true
      adapter_class: edison.core.adapters.platforms.pal.adapter.PalAdapter
      description: "Pal MCP / Cline integration"
      output_path: ".pal/conf"
      sync:
        agents:
          enabled: true
          source: "{{PROJECT_EDISON_DIR}}/_generated/agents"
          destination: ".pal/conf/systemprompts/clink/project"
          filename_pattern: "agent-{name}.txt"
        validators:
          enabled: true
          source: "{{PROJECT_EDISON_DIR}}/_generated/validators"
          destination: ".pal/conf/systemprompts/clink/project"
          source_glob: "*.md"
          recursive: true
          filename_pattern: "validator-{name}.txt"

    # -------------------------------------------------------------------------
    # CODERABBIT (CodeRabbit CI)
    # -------------------------------------------------------------------------
    coderabbit:
      enabled: true
      adapter_class: edison.core.adapters.platforms.coderabbit.CoderabbitAdapter
      description: "CodeRabbit CI integration"
      output_path: "."
      filename: ".coderabbit.yaml"

    # -------------------------------------------------------------------------
    # CODEX (OpenAI Codex)
    # -------------------------------------------------------------------------
    codex:
      enabled: false
      adapter_class: edison.core.adapters.platforms.codex.CodexAdapter
      description: "OpenAI Codex integration"
      output_path: ".codex"
      sync:
        agents:
          enabled: false
          source: "{{PROJECT_EDISON_DIR}}/_generated/agents"
          destination: ".codex/prompts"

    # -------------------------------------------------------------------------
    # OPENCODE (OpenCode / Anthropic CLI)
    # -------------------------------------------------------------------------
    opencode:
      enabled: false
      adapter_class: edison.core.adapters.platforms.opencode.OpenCodeAdapter
      description: "OpenCode integration (plugin, agents, commands)"
      output_path: ".opencode"

# Unified Composition Schema
# Defines section handling for all composable content types
#
# ============================================================================
# SECTION SYNTAX (Unified 4-Concept System)
# ============================================================================
#
# 1. DEFINE SECTION: <!-- SECTION: name -->content<!-- /SECTION: name -->
#    Creates a named, extensible, extractable region in a template.
#
# 2. EXTEND SECTION: <!-- EXTEND: name -->content<!-- /EXTEND -->
#    Adds content to an existing section from pack/project overlays.
#
# 3. INCLUDE SECTION: {{include-section:path#name}}
#    Embeds extracted section content from another file.
#
# 4. REFERENCE SECTION: {{reference-section:path#name|purpose}}
#    Creates a pointer to a section without embedding content.
#
# Convention: Use <!-- SECTION: composed-additions --> for pack/project content.
# Packs extend via <!-- EXTEND: composed-additions -->content<!-- /EXTEND -->
#
# ============================================================================

version: "2.0"

# Default composition settings
defaults:
  dedupe_strategy: shingles  # 12-word shingles for deduplication
  dedupe_min_shingles: 3

# Content type definitions
content_types:
  agents:
    description: "Agent prompt templates with tools and guidelines"
    
    known_sections:
      - name: role
        mode: replace
        description: "Core role definition (not extensible)"
        
      - name: tools
        mode: append
        description: "Available tools for the agent"
        
      - name: guidelines
        mode: append
        description: "Guidelines and best practices"
        
      - name: architecture
        mode: append
        description: "Architecture patterns and constraints"
        
      - name: examples
        mode: append
        description: "Code examples and patterns"
        
      - name: composed-additions
        mode: append
        description: "Pack/project additional content"
    
  validators:
    description: "Validator prompt templates with checks and criteria"
    
    known_sections:
      - name: purpose
        mode: replace
        description: "Core purpose definition"
        
      - name: checks
        mode: append
        description: "Validation checks to perform"
        
      - name: examples
        mode: append
        description: "Code examples showing pass/fail cases"
        
      - name: tech-stack
        mode: append
        description: "Tech-stack specific validation rules"
        
      - name: composed-additions
        mode: append
        description: "Pack/project additional content"
    
  guidelines:
    description: "Guideline documents with best practices"
    
    # Guidelines use full-document composition (concatenate + dedupe)
    composition_mode: concatenate
    dedupe: true
    
    known_sections:
      - name: overview
        mode: replace
        description: "Core overview"
        
      - name: principles
        mode: append
        description: "Guiding principles"
        
      - name: practices
        mode: append
        description: "Best practices"
        
      - name: examples
        mode: append
        description: "Examples and patterns"
        
      - name: composed-additions
        mode: append
        description: "Pack/project additional content"
    
  constitutions:
    description: "Role constitutions with mandatory rules"
    
    known_sections:
      - name: identity
        mode: replace
        description: "Core role identity"
        
      - name: mandatory-reads
        mode: append
        description: "Required document reads"
        
      - name: rules
        mode: append
        description: "Applicable rules"
        
      - name: workflow
        mode: append
        description: "Workflow steps"
        
      - name: composed-additions
        mode: append
        description: "Pack/project additional content"
    
  rules:
    description: "Rule definitions from YAML registries"
    
    # Rules use YAML merge strategy
    composition_mode: yaml_merge
    merge_key: id
    
    known_sections: []  # Rules don't use markdown sections

  canonical-entry:
    description: "Project root entry point (AGENTS.md) with mandatory constitution read"
    
    # Canonical entry is mostly static - minimal extension points
    known_sections:
      - name: mandatory-read
        mode: replace
        description: "Mandatory constitution read instructions (not extensible)"
        
      - name: role-determination
        mode: replace
        description: "How to determine role (not extensible)"
        
      - name: composed-additions
        mode: append
        description: "Pack/project additional content"

  clients:
    description: "Client-specific configuration files (Claude, Zen, Codex)"
    
    known_sections:
      - name: entry-point
        mode: replace
        description: "Reference to AGENTS.md entry point"
        
      - name: client-specific
        mode: append
        description: "Client-specific instructions"
        
      - name: composed-additions
        mode: append
        description: "Pack/project additional content"

  start:
    description: "Session start prompts for orchestrators (new, resume, validate)"
    
    # Start prompts use full-document composition (concatenate + dedupe)
    composition_mode: concatenate
    dedupe: true
    
    known_sections:
      - name: checklist
        mode: append
        description: "Pre-session checklist items"
        
      - name: protocol
        mode: append
        description: "Session protocol steps"
        
      - name: commands
        mode: append
        description: "CLI commands for the session type"
        
      - name: composed-additions
        mode: append
        description: "Pack/project additional content"

# Directory conventions (unified across all types)
directory_conventions:
  overlays_subfolder: "overlays"
  
  # Path patterns for each layer
  # Bundled defaults come from edison.data package
  # Project overrides come from {project_dir}/{type}/
  pack_overlay: "{bundled_packs_dir}/{pack}/{type}/overlays/{name}.md"
  pack_new: "{bundled_packs_dir}/{pack}/{type}/{name}.md"
  project_overlay: "{project_dir}/{type}/overlays/{name}.md"
  project_new: "{project_dir}/{type}/{name}.md"
  
  # Naming conventions for constitutions (special case)
  # Bundled constitutions: edison.data/constitutions/{role}-base.md
  constitution_pack: "{bundled_packs_dir}/{pack}/constitutions/{role}-additions.md"
  constitution_project: "{project_dir}/constitutions/{role}-overrides.md"

# Validation rules
validation:
  # Error if overlay references non-existent entity
  overlay_must_exist: true
  
  # Error if new definition shadows existing entity
  no_shadowing: true
  
  # Warn on sections that don't match any known section
  warn_unknown_sections: true

# =============================================================================
# OUTPUT CONFIGURATION
# =============================================================================
# Configure where composed files are written.
# All paths are relative to repo root unless absolute.
# Use {{PROJECT_EDISON_DIR}} placeholder for project config directory.
#
# Project-level overrides: Create a composition.yaml in your .edison/ directory
# and override only the outputs you want to customize.

outputs:
  # -------------------------------------------------------------------------
  # Canonical Entry Point (AGENTS.md)
  # -------------------------------------------------------------------------
  # The main entry point file that directs LLMs to their role constitution.
  # Default: Written to repo root as AGENTS.md
  canonical_entry:
    enabled: true
    # Where to write the file (relative to repo root)
    output_path: "."
    # Filename (can be customized, e.g., "AGENTS_COMPOSED.md")
    filename: "AGENTS.md"
    # Source template (relative to edison data dir)
    template: "canonical/AGENTS.md"

  # -------------------------------------------------------------------------
  # Client Files (CLAUDE.md, zen.md, etc.)
  # -------------------------------------------------------------------------
  # Client-specific configuration files.
  # Each client can be individually enabled/disabled and configured.
  clients:
    # Claude Code client
    claude:
      enabled: true
      # Where to write (relative to repo root)
      output_path: ".claude"
      filename: "CLAUDE.md"
      template: "clients/claude.md"
    
    # Zen MCP client
    zen:
      enabled: true
      output_path: ".zen/conf"
      filename: "zen.md"
      template: "clients/zen.md"
    
    # Codex client (example of disabled by default)
    codex:
      enabled: false
      output_path: ".codex"
      filename: "CODEX.md"
      template: "clients/codex.md"
    
    # Cursor IDE client
    cursor:
      enabled: false
      output_path: ".cursor"
      filename: "CURSOR.md"
      template: "clients/cursor.md"

  # -------------------------------------------------------------------------
  # Constitutions
  # -------------------------------------------------------------------------
  # Role-specific constitution files.
  constitutions:
    enabled: true
    # Base output directory (relative to project config dir)
    output_path: "{{PROJECT_EDISON_DIR}}/_generated/constitutions"
    # Individual constitution files
    files:
      orchestrators:
        enabled: true
        filename: "ORCHESTRATORS.md"
      agents:
        enabled: true
        filename: "AGENTS.md"
      validators:
        enabled: true
        filename: "VALIDATORS.md"

  # -------------------------------------------------------------------------
  # Agents
  # -------------------------------------------------------------------------
  # Composed agent prompt files.
  agents:
    enabled: true
    output_path: "{{PROJECT_EDISON_DIR}}/_generated/agents"
    # File naming pattern: {agent_name}.md
    filename_pattern: "{name}.md"

  # -------------------------------------------------------------------------
  # Validators
  # -------------------------------------------------------------------------
  # Composed validator prompt files.
  validators:
    enabled: true
    output_path: "{{PROJECT_EDISON_DIR}}/_generated/validators"
    # File naming pattern: {validator_name}.md
    filename_pattern: "{name}.md"

  # -------------------------------------------------------------------------
  # Guidelines
  # -------------------------------------------------------------------------
  # Composed guideline files.
  guidelines:
    enabled: true
    output_path: "{{PROJECT_EDISON_DIR}}/_generated/guidelines"
    # Preserve source directory structure
    preserve_structure: true
    filename_pattern: "{name}.md"

  # -------------------------------------------------------------------------
  # Start Prompts
  # -------------------------------------------------------------------------
  # Session start prompts for orchestrators.
  start:
    enabled: true
    output_path: "{{PROJECT_EDISON_DIR}}/_generated/start"
    filename_pattern: "{name}.md"

  # -------------------------------------------------------------------------
  # CodeRabbit Configuration
  # -------------------------------------------------------------------------
  # CodeRabbit AI code review tool configuration.
  coderabbit:
    enabled: true
    output_path: "."
    filename: ".coderabbit.yaml"

  # -------------------------------------------------------------------------
  # Client Sync Outputs
  # -------------------------------------------------------------------------
  # Where synced files are written for each client.
  # These are the final locations after adapter processing.
  sync:
    claude:
      enabled: true
      # Agents synced to .claude/agents/
      agents_path: ".claude/agents"
      # Agent filename pattern
      agents_filename_pattern: "{name}.md"

    zen:
      enabled: true
      # Zen prompts synced to .zen/conf/systemprompts/
      prompts_path: ".zen/conf/systemprompts/clink"
      prompts_filename_pattern: "{name}.txt"

# =============================================================================
# COMPOSITION WORKFLOW SETTINGS
# =============================================================================
# Used by orchestrators for workflow coordination.

composition:
  workflowLoop:
    command: "edison session next"
    frequency: "Every task cycle"
    readOrder:
      - "Task file in .project/tasks/"
      - "Relevant guidelines from .edison/"
      - "Existing code in scope"
      - "Run tests and validation"
  
  # Generated file header template
  generatedFileHeader: |
    <!--
      AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
      Generated by: Edison Framework v2.0.0
      Template: {{template}}
      Generated at: {{timestamp}}
      Project config root: {{PROJECT_EDISON_DIR}}

      To modify, edit the source template or configuration.
    -->
  
  # DRY detection settings
  dryDetection:
    minShingles: 5
    shingleSize: 12
    threshold: 0.37
    minSimilarity: 0.3

  # Include file settings
  includes:
    max_depth: 3

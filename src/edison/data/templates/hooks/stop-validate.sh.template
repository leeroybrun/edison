#!/usr/bin/env bash
# Edison Hook: {{ id }}
# Type: {{ type }}
# Description: {{ description }}
# Blocking: {{ "YES" if blocking else "NO" }}

# Source shared guard and check execution scope
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$SCRIPT_DIR/_edison_guard.sh" ]]; then
    # shellcheck source=_edison_guard.sh
    source "$SCRIPT_DIR/_edison_guard.sh"
    edison_hook_guard "{{ id }}" "{{ execution_scope }}"
fi

echo ""
echo "Edison Stop Validation..."

{% set cfg = config if config is defined else {} %}
{% set run_quick_validation = cfg.get("run_quick_validation", False) %}

{% if run_quick_validation %}
# Run quick validation checks
ISSUES=0

# Check if task is in valid state (from session context)
TASK_STATE=$(edison session context --json 2>/dev/null | jq -r '.currentTaskState // empty' 2>/dev/null)
if [[ "$TASK_STATE" == "wip" ]]; then
  echo "   ⚠️  Task still in wip state - remember to mark as done"
  ISSUES=$((ISSUES + 1))
fi

# Check for uncommitted changes
if ! git diff --quiet 2>/dev/null; then
  echo "   ⚠️  Uncommitted changes present"
  ISSUES=$((ISSUES + 1))
fi

# Check if tests pass
if ! edison ci test --quick 2>/dev/null; then
  echo "   ⚠️  Quick tests failing"
  ISSUES=$((ISSUES + 1))
fi

if [[ $ISSUES -gt 0 ]]; then
  echo ""
  echo "   Found $ISSUES issues - consider addressing before stopping"
else
  echo "   ✅ All quick checks passed"
fi
{% endif %}

echo ""
exit 0

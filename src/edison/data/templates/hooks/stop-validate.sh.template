#!/usr/bin/env bash
# Edison Hook: {{ id }}
# Type: {{ type }}
# Description: {{ description }}
# Blocking: {{ "YES" if blocking else "NO" }}

# Fast check: Skip if no Edison session file exists
SESSION_FILE=".project/.session-id"
if [[ ! -f "$SESSION_FILE" ]]; then
  exit 0  # No Edison session, skip hook
fi

echo ""
echo "Edison Stop Validation..."

{% set cfg = config if config is defined else {} %}
{% set run_quick_validation = cfg.get("run_quick_validation", False) %}

{% if run_quick_validation %}
# Run quick validation checks
ISSUES=0

# Check if task is in valid state
TASK_STATE=$(edison task status --current --json 2>/dev/null | jq -r '.state // empty' 2>/dev/null)
if [[ "$TASK_STATE" == "wip" ]]; then
  echo "   ⚠️  Task still in wip state - remember to mark as done"
  ISSUES=$((ISSUES + 1))
fi

# Check for uncommitted changes
if ! git diff --quiet 2>/dev/null; then
  echo "   ⚠️  Uncommitted changes present"
  ISSUES=$((ISSUES + 1))
fi

# Check if tests pass
if ! edison ci test --quick 2>/dev/null; then
  echo "   ⚠️  Quick tests failing"
  ISSUES=$((ISSUES + 1))
fi

if [[ $ISSUES -gt 0 ]]; then
  echo ""
  echo "   Found $ISSUES issues - consider addressing before stopping"
else
  echo "   ✅ All quick checks passed"
fi
{% endif %}

echo ""
exit 0

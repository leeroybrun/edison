#!/usr/bin/env bash
# Edison Hook: {{ id }}
# Type: {{ type }}
# Description: {{ description }}
# Blocking: {{ "YES" if blocking else "NO" }} (warn-only)

# Fast check: Skip if no Edison session file exists
{% set mgmt_dir = global_config.get("project_management_dir") %}
SESSION_FILE="{{ mgmt_dir }}/.session-id"
if [[ ! -f "$SESSION_FILE" ]]; then
  exit 0  # No Edison session, skip hook
fi

# Parse input JSON (with timeout to prevent hanging)
INPUT=$(timeout 1 cat 2>/dev/null || echo '{}')
FILE_PATH=$(echo "$INPUT" | jq -r '.args.file_path // empty' 2>/dev/null || echo "")

{% set cfg = config if config is defined else {} %}
{% set skip_test_files = cfg.get("skip_test_files", False) %}
{% set warn_if_missing = cfg.get("warn_if_missing", False) %}

{% if skip_test_files %}
# Skip obvious test files (stack-agnostic heuristic)
if echo "$FILE_PATH" | grep -qE '(^|/)(test|tests|spec|specs)(/|$)|(^|/)test[^/]*\\.|\\.(test|spec)\\.'; then
  exit 0
fi
{% endif %}

{% if warn_if_missing %}
echo ""
echo "⚠️  Test reminder for: $FILE_PATH"
echo "   Ensure the change is covered by appropriate tests per your project's conventions."
echo "   Follow TDD: write failing test (RED) → minimal fix (GREEN) → cleanup (REFACTOR)."
echo ""
{% endif %}

exit 0

#!/usr/bin/env bash
# Edison Hook: {{ id }}
# Type: {{ type }}
# Description: {{ description }}
# Blocking: {{ "YES" if blocking else "NO" }} (warn-only)

# Fast check: Skip if no Edison session file exists
SESSION_FILE=".project/.session-id"
if [[ ! -f "$SESSION_FILE" ]]; then
  exit 0  # No Edison session, skip hook
fi

# Parse input JSON (with timeout to prevent hanging)
INPUT=$(timeout 1 cat 2>/dev/null || echo '{}')
FILE_PATH=$(echo "$INPUT" | jq -r '.args.file_path // empty' 2>/dev/null || echo "")

{% set cfg = config if config is defined else {} %}
{% set skip_test_files = cfg.get("skip_test_files", False) %}
{% set warn_if_missing = cfg.get("warn_if_missing", False) %}

{% if skip_test_files %}
# Skip test files
if echo "$FILE_PATH" | grep -qE '\\.(test|spec)\\.(ts|js|tsx|jsx|py)$'; then
  exit 0
fi
{% endif %}

# Try to find corresponding test file
TEST_PATTERNS=(
  "${FILE_PATH%.ts}.test.ts"
  "${FILE_PATH%.js}.test.js"
  "${FILE_PATH%.py}_test.py"
  "${FILE_PATH%.tsx}.test.tsx"
  "${FILE_PATH%.jsx}.test.jsx"
)

TEST_EXISTS=false
for pattern in "${TEST_PATTERNS[@]}"; do
  if [[ -f "$pattern" ]]; then
    TEST_EXISTS=true
    break
  fi
done

{% if warn_if_missing %}
if [[ "$TEST_EXISTS" != "true" ]]; then
  echo ""
  echo "⚠️  No test file found for: $FILE_PATH"
  echo "   Consider creating tests following TDD workflow"
  echo ""
fi
{% endif %}

exit 0

#!/usr/bin/env bash
# Edison Hook: {{ id }}
# Type: {{ type }}
# Description: {{ description }}
# Blocking: {{ "YES - CAN BLOCK COMMITS" if blocking else "NO" }}

# Fast check: Skip if no Edison session file exists
SESSION_FILE=".project/.session-id"
if [[ ! -f "$SESSION_FILE" ]]; then
  exit 0  # No Edison session, skip hook
fi

# Parse input JSON (with timeout to prevent hanging)
INPUT=$(timeout 1 cat 2>/dev/null || echo '{}')
TOOL_NAME=$(echo "$INPUT" | jq -r '.tool' 2>/dev/null || echo "")

{% set cfg = config if config is defined else {} %}
{% set require_tests = cfg.get("require_tests_pass", False) %}
{% set require_coverage = cfg.get("require_coverage", False) %}
{% set coverage_threshold = cfg.get("coverage_threshold", 80) %}

# Only for git commit
if [[ "$TOOL_NAME" != "Bash" ]]; then
  exit 0
fi

COMMAND=$(echo "$INPUT" | jq -r '.args.command // ""' 2>/dev/null || echo "")
if [[ "$COMMAND" != *"git commit"* ]]; then
  exit 0
fi

echo "ðŸ” Edison Commit Guard: Checking tests..."

{% if require_tests %}
# Run tests
if ! edison ci test 2>&1 | tee /tmp/edison-commit-guard.log; then
  echo ""
  echo "âŒ Commit blocked: Tests are failing"
  echo ""
  echo "Fix failing tests before committing."
  echo "Run: edison ci test"
  echo ""
  exit 1  # BLOCK
fi
{% endif %}

{% if require_coverage %}
# Check coverage
COVERAGE=$(edison ci coverage --json 2>/dev/null | jq -r '.overall' || echo "0")
THRESHOLD={{ coverage_threshold }}

if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
  echo ""
  echo "âŒ Commit blocked: Coverage too low ($COVERAGE% < $THRESHOLD%)"
  echo ""
  echo "Increase test coverage before committing."
  echo ""
  exit 1  # BLOCK
fi
{% endif %}

echo "âœ… Commit guard passed"
exit 0

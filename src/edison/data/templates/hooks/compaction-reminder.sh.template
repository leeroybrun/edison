#!/usr/bin/env bash
# Edison Hook: {{ id }}
# Type: {{ type }}
# Description: {{ description }}
#
# This hook is triggered automatically by Claude Code BEFORE context compaction.
# It reminds the agent to re-read its constitution after compaction completes.

# Fast check: Skip if no Edison session file exists
SESSION_FILE=".project/.session-id"
if [[ ! -f "$SESSION_FILE" ]]; then
  exit 0  # No Edison session, skip hook
fi

{% set cfg = config if config is defined else {} %}
{% set log_cfg = cfg.get("log", {}) %}

# Configuration from hooks.yaml
ROLE="{{ cfg.get('default_role', 'agents') }}"
MESSAGE_TEMPLATE="{{ cfg.get('message_template', 'Context compacted. Re-read your constitution at: .edison/_generated/constitutions/{ROLE}.md') }}"
NOTIFY="{{ cfg.get('notify', True) }}"
LOG_ENABLED="{{ log_cfg.get('enabled', False) }}"
LOG_PATH="{{ log_cfg.get('path', '.edison/logs/compaction.log') }}"

# Expand {ROLE} placeholder in message template
MESSAGE="${MESSAGE_TEMPLATE//\{ROLE\}/$ROLE}"

# Output reminder (Claude Code will inject this into context)
if [ "$NOTIFY" = "true" ] || [ "$NOTIFY" = "True" ]; then
    echo "$MESSAGE"
fi

# Log compaction event if enabled
{% if log_cfg.get('enabled', False) %}
if [ "$LOG_ENABLED" = "true" ] || [ "$LOG_ENABLED" = "True" ]; then
    TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    mkdir -p "$(dirname "$LOG_PATH")" 2>/dev/null || true
    echo "$TIMESTAMP role=$ROLE source=precompact message=$MESSAGE" >> "$LOG_PATH" 2>/dev/null || true
fi
{% endif %}

exit 0

#!/bin/sh
set -eu

# Edison git guard shim
# Generated by Edison. To modify behavior, update shims config and regenerate.

ALLOW_ENV="{{ cfg.get('allow_env', 'EDISON_ALLOW_DESTRUCTIVE_GIT') }}"
DISABLE_ENV="{{ cfg.get('disable_env', 'EDISON_DISABLE_GIT_GUARD_SHIM') }}"
EXIT_CODE={{ cfg.get('exit_code', 89) }}

SHIM_DIR="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)"

PATH_NO_SHIM="$(printf "%s" "${PATH:-}" | awk -v RS=: -v ORS=: -v s="$SHIM_DIR" '$0 != s { printf "%s:", $0 }' | sed 's/:$//')"
REAL_GIT="$(PATH="$PATH_NO_SHIM" command -v git 2>/dev/null || true)"
if [ -z "$REAL_GIT" ] && [ -x /usr/bin/git ]; then
  REAL_GIT="/usr/bin/git"
fi
if [ -z "$REAL_GIT" ]; then
  echo "EDISON: git guard shim could not locate real git binary." >&2
  echo "EDISON: re-run 'edison shims sync' or set $DISABLE_ENV=1 to bypass shims." >&2
  exit 127
fi

# Bypass entirely (power-user escape hatch)
DISABLE_VAL=""
eval "DISABLE_VAL=\${${DISABLE_ENV}:-}"
if [ -n "$DISABLE_VAL" ]; then
  exec "$REAL_GIT" "$@"
fi

if [ "$#" -lt 1 ]; then
  exec "$REAL_GIT" "$@"
fi

SUBCMD="$1"
shift || true

case "$SUBCMD" in
{% for c in (cfg.get("blocked_subcommands") or []) %}
  {{ c }}) ;;
{% endfor %}
  *)
    exec "$REAL_GIT" "$SUBCMD" "$@"
    ;;
esac

ALLOW_VAL=""
eval "ALLOW_VAL=\${${ALLOW_ENV}:-}"
if [ -z "$ALLOW_VAL" ]; then
  echo "EDISON: blocked potentially destructive git command: git $SUBCMD" >&2
  echo "EDISON: set $ALLOW_ENV=1 to override intentionally." >&2
  exit "$EXIT_CODE"
fi

exec "$REAL_GIT" "$SUBCMD" "$@"

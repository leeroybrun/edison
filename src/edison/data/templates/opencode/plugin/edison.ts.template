/**
 * Edison OpenCode plugin (generated).
 *
 * Generated by: `edison opencode setup`
 *
 * Edison is the source of truth for completion/continuation:
 *   `edison session next --json --completion-only`
 *
 * This plugin is intentionally thin; behavioral enforcement (idle loops, budgets,
 * truncation) is implemented in Edison config + the plugin logic task (040).
 */

type EdisonSessionNext = {
  sessionId?: string;
  completion?: { isComplete?: boolean };
  continuation?: { shouldContinue?: boolean; prompt?: string };
};

async function fetchEdisonSessionNext(): Promise<EdisonSessionNext | null> {
  try {
    const proc = Bun.spawn(
      ["edison", "session", "next", "--json", "--completion-only"],
      { stdout: "pipe", stderr: "pipe" },
    );
    const out = await new Response(proc.stdout).text();
    await proc.exited;
    return JSON.parse(out) as EdisonSessionNext;
  } catch {
    return null;
  }
}

export const Edison = async ({ client }: { client: any }) => {
  return {
    event: async ({ event }: { event: { type: string } }) => {
      if (event.type !== "session.idle") return;

      const payload = await fetchEdisonSessionNext();
      const shouldContinue = Boolean(payload?.continuation?.shouldContinue);
      const prompt = String(payload?.continuation?.prompt || "");
      if (!shouldContinue || !prompt) return;

      // Minimal, non-invasive integration: append to the current TUI prompt.
      // Task 040 adds enforcement (submit, cooldowns, iteration budgets, truncation).
      await client.tui.appendPrompt({ body: { text: `${prompt}\n` } });
    },
  };
};


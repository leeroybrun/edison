# TDD (Test-Driven Development) - Include-Only File

<!-- WARNING: This file is for {{include-section:}} only. DO NOT read directly. -->

<!-- section: principles -->
## TDD Principles (All Roles)

Test-Driven Development is NON-NEGOTIABLE for all implementation work.

### The RED-GREEN-REFACTOR Cycle
- **RED**: Write a failing test first and confirm it fails for the right reason
- **GREEN**: Add the minimum code required to make the test passâ€”no extras
- **REFACTOR**: Improve the code with all tests green, then rerun the full suite
- Repeat the cycle for every feature/change

### Core Rules
- Fail first; do not skip the RED step
- Minimal green code; avoid speculative features
- Refactor with a full test run before proceeding
- Coverage targets from project config (typically â‰¥90% overall; 100% on new/changed files)
- Update tests only to reflect agreed spec/format changes, never just to "make green"
- Keep output cleanâ€”no console noise

### Guardrails
- No `.skip` / `.todo` / `.only` (or equivalents) committed
- Do not leave debugging logs in tests
- Evidence must be generated by trusted runners, not manually fabricated

### Commit Tag Requirements
Commits MUST include explicit markers to document TDD compliance:
- `[RED]` tag for commits with failing test (test written before implementation)
- `[GREEN]` tag for commits where tests pass (minimal implementation added)
- `[REFACTOR]` tag for commits with code cleanup (tests still green)
<!-- /section: principles -->

<!-- section: agent-execution -->
## TDD Execution (Agents)

### Mandatory Workflow

#### 1. RED Phase: Write Tests First
Write tests BEFORE any implementation code. Tests MUST fail initially.

**Verify RED Phase**:
```bash
<run test command from active test framework>
# Expected: Test FAILS (implementation not written yet)
```

**RED Phase Checklist**:
- [ ] Test written BEFORE implementation
- [ ] Test fails when run
- [ ] Test failure message is clear
- [ ] Test covers the specific functionality

#### 2. GREEN Phase: Minimal Implementation
Write the MINIMUM code needed to make the test pass.

**Verify GREEN Phase**:
```bash
<run test command from active test framework>
# Expected: Test PASSES
```

**GREEN Phase Checklist**:
- [ ] Implementation makes test pass
- [ ] No extra code beyond what's needed
- [ ] Test passes consistently

#### 3. REFACTOR Phase: Clean Up
Improve code quality while keeping tests passing.

**Verify REFACTOR Phase**:
```bash
<run test command from active test framework>
# Expected: ALL tests still PASS
```

**REFACTOR Phase Checklist**:
- [ ] Code is cleaner/more readable
- [ ] Error handling added
- [ ] Validation added
- [ ] ALL tests still pass

### Evidence Requirements
- Test file created/committed BEFORE implementation file (verify via git history)
- Commits MUST include explicit markers: `[RED]` then `[GREEN]` (in order)
- RED failure documented â†’ GREEN pass documented â†’ REFACTOR documented
- Attach test output showing the failing run and the passing run
- Include a coverage report for the round
- Use `edison task ready --run` to collect trusted evidence files
- If TDD must be skipped, call `edison task ready --disable-tdd --reason "justification"` and record the rationale

### What NOT To Do
**NEVER**:
- Implement before writing tests
- "I'll add tests later" - NO!
- Skip test verification (RED phase must fail)
- Use excessive mocking (test real behavior)
- Leave skipped tests (`.skip()`)
- Commit with failing tests

### Performance Targets
| Test Type | Target Time | Description |
|-----------|-------------|-------------|
| Unit tests | <100ms each | Pure logic, no external dependencies |
| Integration tests | <1s each | Multiple components working together |
| API/Service tests | <100ms each | Service layer with real dependencies |
| UI/Component tests | <200ms each | Rendering and interaction tests |
| End-to-End tests | <5s each | Full user journey tests |
<!-- /section: agent-execution -->

<!-- section: validator-check -->
## TDD Compliance Checking (Validators)

### Verification Checklist
- [ ] Tests exist in appropriate test directory
- [ ] Test file created BEFORE implementation (check git history)
- [ ] Tests cover the requirements specified in task

### Red Phase Evidence
- [ ] Sub-agent showed tests failing initially
- [ ] Failure messages indicate tests were actually testing something
- [ ] No "test.skip" or commented-out tests

### Green Phase Evidence
- [ ] All tests now passing
- [ ] No tests were removed or weakened to pass
- [ ] Coverage meets minimum threshold

### Refactor Phase (if applicable)
- [ ] Tests still pass after refactoring
- [ ] Code is cleaner without changing behavior
- [ ] No new functionality added during refactor

### Red Flags (Immediate Rejection)
ðŸš© **Immediate Rejection:**
- Tests written AFTER implementation (check git history)
- Tests that always pass (no assertions)
- Mocked everything (no real behavior tested)
- Coverage below threshold with no justification
- Tests removed to make suite pass

ðŸŸ¡ **Needs Review:**
- Coverage just barely meets threshold
- Complex tests that are hard to understand
- Tests coupled to implementation details
- Missing edge case coverage
<!-- /section: validator-check -->

<!-- section: orchestrator-verify -->
## TDD Verification (Orchestrators)

### Before Accepting Work from Sub-Agent

#### 1. Test-First Evidence
- [ ] Tests exist in the appropriate test directory for the active stack (per pack conventions)
- [ ] Test file created BEFORE implementation (check git history)
- [ ] Tests cover the requirements specified in task

#### 2. Red Phase Evidence
- [ ] Sub-agent showed tests failing initially
- [ ] Failure messages indicate tests were actually testing something
- [ ] No "test.skip" or commented-out tests

#### 3. Green Phase Evidence
- [ ] All tests now passing
- [ ] No tests were removed or weakened to pass
- [ ] Coverage meets minimum threshold (see quality.coverageTarget)

#### 4. Refactor Phase (if applicable)
- [ ] Tests still pass after refactoring
- [ ] Code is cleaner without changing behavior
- [ ] No new functionality added during refactor

### TDD Delegation Templates

#### Component Builder Delegation
```
Task(subagent_type='component-builder', prompt=`
Build [Component] using TDD:

CRITICAL: Follow TDD cycle strictly (RED-GREEN-REFACTOR)

1. FIRST: Write component test (`[Component].test.<ext>`)
   RUN TEST: Verify test FAILS (component doesn't exist yet)
   Document failure in response

2. THEN: Implement component (`[Component].<ext>`)
   RUN TEST: Verify tests PASS
   Document success in response

3. FINALLY: Refactor (if needed)
   RUN ALL TESTS: Verify tests still PASS
   Document success in response

Return:
- Component file
- Test file
- Test execution results (RED, GREEN, REFACTOR phases)
- Verification that TDD cycle was followed
`)
```

#### API Builder Delegation
```
Task(subagent_type='api-builder', prompt=`
Implement [endpoint] using TDD:

CRITICAL: Follow TDD cycle strictly (RED-GREEN-REFACTOR)

1. FIRST: Write API integration test
   RUN TEST: Verify tests FAIL
   Document failure in response

2. THEN: Implement API route
   RUN TEST: Verify tests PASS
   Document success in response

3. FINALLY: Refactor (if needed)
   RUN ALL TESTS: Verify tests still PASS

Return:
- Route file
- Test file
- Test execution results (RED, GREEN, REFACTOR phases)
- Verification of TDD cycle
`)
```
<!-- /section: orchestrator-verify -->

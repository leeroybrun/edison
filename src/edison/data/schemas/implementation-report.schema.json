{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "ImplementationReport",
  "description": "Mandatory structured report for every task implementation, regardless of whether work was delegated or done directly by orchestrator. Captures outcomes, blockers, follow-ups, and context for validators.",
  "type": "object",
  "required": ["taskId", "round", "implementationApproach", "primaryModel", "completionStatus", "followUpTasks", "notesForValidator", "tracking"],
  "properties": {
    "taskId": {
      "type": "string",
      "description": "Task ID this report describes (e.g., '150-wave2-auth-gate')"
    },
    "round": {
      "type": "integer",
      "minimum": 1,
      "description": "Implementation round number (starts at 1, increments on rework)"
    },
    "implementationApproach": {
      "type": "string",
      "enum": ["orchestrator-direct", "delegated-single", "delegated-mixed"],
      "description": "How the work was performed: orchestrator-direct (orchestrator implemented without delegation), delegated-single (one sub-agent), delegated-mixed (orchestrator coordinated multiple sub-agents)"
    },
    "primaryModel": {
      "type": "string",
      "enum": ["claude", "codex", "gemini"],
      "description": "Primary AI model that performed the implementation work"
    },
    "completionStatus": {
      "type": "string",
      "enum": ["complete", "blocked", "partial"],
      "description": "Implementation outcome: complete (all acceptance criteria met), blocked (cannot proceed without external input), partial (some work done, more needed)"
    },
    "delegations": {
      "type": "array",
      "description": "Optional: Details of delegated work (only required when implementationApproach is 'delegated-single' or 'delegated-mixed')",
      "items": {
        "type": "object",
        "required": ["filePattern", "model", "role"],
        "properties": {
          "filePattern": {
            "type": "string",
            "description": "File or file pattern delegated (e.g., 'path/to/resource.ext')"
          },
          "model": {
            "type": "string",
            "description": "Model used for this delegation (codex, claude, gemini)"
          },
          "role": {
            "type": "string",
            "description": "Zen MCP role used (e.g., 'api-builder', 'component-builder-nextjs')"
          },
          "rationale": {
            "type": "string",
            "description": "Why this model/role was selected for this work"
          },
          "continuationId": {
            "type": "string",
            "description": "Zen MCP continuation ID for this delegation (if applicable)"
          },
          "outcome": {
            "type": "string",
            "enum": ["success", "mismatch", "error"],
            "description": "Outcome of this delegation"
          }
        }
      }
    },
    "blockers": {
      "type": "array",
      "description": "Obstacles encountered during implementation that prevent completion or require external resolution",
      "items": {
        "type": "object",
        "required": ["description"],
        "properties": {
          "description": {
            "type": "string",
            "description": "What is blocking progress"
          },
          "severity": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"],
            "description": "Impact severity"
          },
          "owner": {
            "type": "string",
            "description": "Who needs to resolve this blocker (e.g., 'user', 'platform-team', 'external-api')"
          }
        }
      },
      "default": []
    },
    "followUpTasks": {
      "type": "array",
      "description": "New tasks discovered during implementation (refactoring opportunities, edge cases, related features, etc.)",
      "items": {
        "type": "object",
        "required": ["title"],
        "properties": {
          "title": {
            "type": "string",
            "description": "Brief title for the follow-up task"
          },
          "description": {
            "type": "string",
            "description": "Detailed description of what needs to be done"
          },
          "type": {
            "type": "string",
            "description": "Task type (e.g., 'ui-component', 'api-route', 'test-suite', 'refactoring')"
          },
          "severity": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"],
            "description": "Urgency/importance"
          },
          "blocking": {
            "type": "boolean",
            "default": false,
            "description": "Whether this must be completed before current task can be validated"
          },
          "claimNow": {
            "type": "boolean",
            "default": false,
            "description": "Whether implementer should claim this immediately"
          },
          "parentId": {
            "type": "string",
            "description": "Parent task ID (current task)"
          },
          "files": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Files this follow-up would touch"
          },
          "suggestedSlug": {
            "type": "string",
            "description": "Suggested task slug/filename"
          },
          "suggestedWave": {
            "type": "string",
            "description": "Suggested wave (wave1, wave2, wave3)"
          },
          "severity": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"],
            "description": "Impact severity of the follow-up"
          },
          "blockingBeforeValidation": {
            "type": "boolean",
            "default": false,
            "description": "If true, this follow-up must be completed before the parent can be promoted to done/validated"
          },
          "claimNow": {
            "type": "boolean",
            "default": false,
            "description": "Orchestrator suggestion to claim the follow-up in the current session"
          },
          "category": {
            "type": "string",
            "enum": ["bugfix", "refactor", "test", "docs", "security", "perf", "migration", "infra"],
            "description": "Classification of follow-up"
          },
          "relatedFiles": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Files/paths related to this follow-up"
          },
          "existingTaskId": {
            "type": "string",
            "description": "If deduped to an existing task, record its ID"
          }
        }
      }
    },
    "notesForValidator": {
      "type": "string",
      "description": "Important context validators should know: trade-offs made, design decisions, areas needing extra scrutiny, known limitations"
    },
    "implementationNotes": {
      "type": "string",
      "description": "Optional: Additional technical notes about the implementation approach, challenges overcome, or patterns used"
    },
    "tddCompliance": {
      "type": "object",
      "description": "TDD workflow compliance details",
      "properties": {
        "followed": {
          "type": "boolean",
          "description": "Whether RED/GREEN/REFACTOR cycle was followed"
        },
        "redEvidence": {
          "type": "string",
          "description": "Path to failing test evidence"
        },
        "greenEvidence": {
          "type": "string",
          "description": "Path to passing test evidence"
        },
        "notes": {
          "type": "string",
          "description": "Notes about TDD compliance or why it wasn't applicable"
        }
      }
    },
    "delegationCompliance": {
      "type": "boolean",
      "description": "Optional: Whether delegation followed .edison/delegation/config.json rules (only relevant when implementationApproach is delegated-*)"
    },
    "tracking": {
      "type": "object",
      "description": "Process tracking metadata - auto-populated by scripts/track CLI",
      "required": ["processId", "startedAt"],
      "properties": {
        "processId": {
          "type": "integer",
          "description": "PID of the process that started this implementation (auto-populated)"
        },
        "startedAt": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when implementation started (auto-populated)"
        },
        "lastActive": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of last heartbeat/activity (optional, for long-running work)"
        },
        "completedAt": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when implementation completed (auto-populated on scripts/track complete)"
        },
        "hostname": {
          "type": "string",
          "description": "Machine hostname (for distributed work tracking)"
        }
      }
    }
  }
}
